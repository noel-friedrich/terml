class TermlSettings{static INLINE_DELIMITER=" ";static LINE_DELIMIETER="\n";static INDENT_CHAR="	";static DEF_KEYWORD="DEF";static COMMENT_CHAR="#";static TAB_WIDTH=4;static maxRepeat=1e3;static OUT_FUNC=e=>{Terml.output+=e};static IN_FUNC=e=>prompt(e)}class TermlError extends Error{static makeName(e){return`Terml${e}Error`}constructor(e){super(e),this.name=TermlError.makeName("")}}class TermlSyntaxError extends TermlError{constructor(e){super(e),this.name=TermlError.makeName("Syntax")}}class TermlRuntimeError extends TermlError{constructor(e){super(e),this.name=TermlError.makeName("Runtime")}static makeName(e){return`TermlRuntime${e}Error`}}class TermlRuntimeNumArgumentsError extends TermlError{constructor(e){super(e),this.name=TermlRuntimeError.makeName("NumArguments")}}class TermlRuntimeTypeError extends TermlError{constructor(e){super(e),this.name=TermlRuntimeError.makeName("Type")}}class TermlRuntimeMaxRepeatError extends TermlError{constructor(e){super(e),this.name=TermlRuntimeError.makeName("MaxRepeat")}}class TermlValueObject{}class TermlLiteral extends TermlValueObject{constructor(e){super(),this._value=e,this.isLiteral=!0}get value(){return this._value}static fromToken(e){if(e.isStringLiteral)return new TermlStringLiteral(e.value);if(e.isNumberLiteral)return new TermlNumberLiteral(e.value);throw new TermlError("Token is not a literal")}}class TermlStringLiteral extends TermlLiteral{constructor(e){super(e)}static fromArray(e){let t="";for(let r of e)t+=String.fromCharCode(r);return new TermlStringLiteral(t)}get stringValue(){return this._value}toString(){return`"${this.value}"`}get value(){let e=[];for(let t of this._value){let r=t.charCodeAt(0);e.push(r)}return e}}class TermlNumberLiteral extends TermlLiteral{constructor(e){super(e)}toString(){return`${this.value}`}}class TermlToken{checkIfNumberLiteral(){if(/^-?\d+(?:\.\d+)?$/.test(this.content)){this.isNumberLiteral=!0,this.content=parseFloat(this.content);let e=TermlVariable.getValueError(this.content);if(e)throw e;return!0}return!1}toString(){return this.content}constructor(e,{isStringLiteral:t=!1}={}){this.content=e,this.isStringLiteral=t,this.isNumberLiteral=this.checkIfNumberLiteral()}get isLiteral(){return this.isStringLiteral||this.isNumberLiteral}toLiteral(){return TermlLiteral.fromToken(this)}get value(){return this.content}}class TermlVariable extends TermlValueObject{constructor(e,t,r){if(super(),!e)throw new TermlError("No name provided");if(this.name=e,this.setValue(t),!(r instanceof TermlVariableContainer))throw new TermlError("Container is not a TermlVariableContainer");this.parentContainer=r,this.isList=!1}toString(){return`VAR{${this.name}}`}toCharacter(){return String.fromCharCode(this.value)}get isRoot(){return void 0===this.parentContainer}get value(){return this._value}set value(e){this.setValue(e)}static getValueError(e){if("number"!=typeof e)return new TermlError("Value is not a number")}setValue(e=0){let t=TermlVariable.getValueError(e);if(t)throw t;this._value=e}get binString(){return this.value.toString(2).padStart(8,"0")}get hexString(){return this.value.toString(16).padStart(2,"0").toUpperCase()}}class TermlList extends TermlValueObject{constructor(e,t,r){if(super(),!e)throw new TermlError("No name provided");if(this.name=e,this.setValue(t),!(r instanceof TermlVariableContainer))throw new TermlError("Container is not a TermlVariableContainer");this.parentContainer=r,this.isList=!0}toString(){return`LIST{${this.name}}`}set value(e){this.setValue(e)}get value(){return this._value}setValue(e=[]){let t=TermlList.getValueError(e);if(t)throw t;this._value=e}static getValueError(e){if(!Array.isArray(e))return new TermlError("Value is not an array");for(let t=0;t<e.length;t++){let r=TermlVariable.getValueError(e[t]);if(r)return r}}getStringContent(){return this.value.map(e=>e.toCharacter()).join()}get binString(){return this.value.map(e=>e.toString(2).padStart(8,"0")).join(" ")}get hexString(){return this.value.map(e=>e.toString(16).padStart(2,"0").toUpperCase()).join(" ")}}class TermlModule{constructor(e,t,r,l){let n=(e,t)=>{let r={};for(let l of e)r[l[t]]=l;return r};if(!e)throw new TermlError("No name provided");this.name=e,this.functions=n(t,"name"),this.variables=n(r,"name"),this.termlCode=l}}class TermlVariableContainer{constructor({name:e,parentContainer:t}={}){if(this.variables={},this.functions={},this.name=e,t&&!(t instanceof TermlVariableContainer))throw new TermlError("Parent container is not a VariableContainer");this.parentContainer=t}importModule(e){if(!(e instanceof TermlModule))throw new TermlError("Module is not a TermlModule");for(let t in e.functions)this.functionExists(t)||this.setFunction(t,e.functions[t]);for(let r in e.variables)this.variableExists(r)||this.setVariable(r,e.variables[r])}setFunction(e,t){if(!e)throw new TermlError("No name provided");if(!(t instanceof TermlFunction))throw new TermlError("Function is not a TermlFunction");this.functions[e]=t}functionExists(e){if(!e)throw new TermlError("No name provided");return void 0!==this.functions[e]}getFunction(e){if(!e)throw new TermlError("No name provided");return this.functions[e]}getVariable(e){if(!e)throw new TermlError("No name provided");return this.variables[e]}variableExists(e){if(!e)throw new TermlError("No name provided");return void 0!==this.variables[e]}setVariable(e,t){if(!e)throw new TermlError("No name provided");if(this.variables[e])this.variables[e].value=t;else try{this.variables[e]=new TermlVariable(e,t,this)}catch(r){try{this.variables[e]=new TermlList(e,t,this)}catch(l){throw new TermlError("Variable is not a TermlVariable or TermlList")}}}}class TermlStatement{constructor(e,t,{substatements:r,parent:l,container:n}={}){if(!e)throw new TermlError("No functionName provided");this.functionName=e,this.args=t||[],this.substatements=r||[],this.container=n||new TermlVariableContainer({name:this.makeContainerName()}),this.parent=l,this.isStatement=!0,this.isFunction=!1}toString(){return`STMT{${this.functionName.value}; ${this.args.map(e=>e.toString()).join(", ")}}`}makeContainerName(){return`STMT{${this.functionName.value}}`}addSubstatement(e){if(!(e instanceof TermlStatement))throw new TermlError("Statement is not a TermlStatement");this.substatements.push(e)}static fromTokens(e,t){if(!e||!e.length)throw new TermlError("No tokens provided");let r=e.shift();return new TermlStatement(r,e,t)}}class TermlFunction{constructor(e,t,r,l){if(!e)throw new TermlError("No name provided");if(this.name=e,this.args=t||[],this.statements=r||[],this.container=new TermlVariableContainer({name:this.makeContainerName()}),l&&"function"!=typeof l)throw new TermlError("jsFunction is not a function");this.jsFunction=l,this.isStatement=!1,this.isFunction=!0}execute(){if(this.jsFunction)return this.jsFunction(...arguments);throw new TermlError("Function has no jsFunction")}makeContainerName(){return`FUNC{${this.name.value}}`}addStatement(e){if(!(e instanceof TermlStatement))throw new TermlError("Statement is not a TermlStatement");this.statements.push(e)}}class TermlParser{constructor(){this.globalStatement=new TermlStatement(new TermlToken("__GLOBAL__"),[],{parent:void 0})}tokenize(e){let t=[],r="",l=!1,n=[TermlSettings.INLINE_DELIMITER],a=['"',"'"],i;for(let m of e)l?m===i?(l=!1,i=void 0,t.push(new TermlToken(r,{isStringLiteral:!0})),r=""):r+=m:a.includes(m)?(l=!0,i=m):n.includes(m)?(""!==r&&t.push(new TermlToken(r)),r=""):r+=m,r===TermlSettings.INDENT_CHAR&&(t.push(new TermlToken(r)),r="");return""!==r&&t.push(new TermlToken(r)),t=t.map(e=>e.isLiteral?e.toLiteral():e)}parseLines(e){let t=e.map(this.tokenize),r=0,l,n=this.globalStatement;for(let a of t){if(0===a.length)continue;let i=0;for(;a[0].value===TermlSettings.INDENT_CHAR;)i++,a.shift();if(i-1>r)throw new TermlSyntaxError("Invalid indentation");for(;i<r;)n=n.parent,r--;if(i>r){if(!l)throw new TermlSyntaxError("Invalid indentation (no previous statement)");n=l}let m=TermlStatement.fromTokens(a,{parent:n});n.addSubstatement(m),l=m,r=i}}extractLines(e){return e.split(TermlSettings.LINE_DELIMIETER).filter(e=>e.trim().length>0)}parse(e){if("string"!=typeof e)throw new TermlError("Input is not a string");return this.parseLines(this.extractLines(e)),this.globalStatement}}const TermlStandardModule=new TermlModule("standard",[new TermlFunction("__GLOBAL__",[],[],(e,t,r)=>{for(let l of(Terml.checkType(e,[]),t.substatements))r.executeStatement(l)}),new TermlFunction("NEW",["name","?value"],[],(e,t,r)=>{let l=t.parent.container;if(!Terml.getTypeError(e,[TermlStringLiteral])){l.setVariable(e[0].stringValue,void 0);return}Terml.checkType(e,[TermlStringLiteral,TermlValueObject]);let[n,a]=e;l.setVariable(n.stringValue,a.value)}),new TermlFunction("NEW_LST",["name","?value"],[],(e,t,r)=>{let l=t.parent.container;if(!Terml.getTypeError(e,[TermlStringLiteral])){l.setVariable(e[0].stringValue,[]);return}window.container=l,Terml.checkType(e,[TermlStringLiteral,TermlStringLiteral]);let[n,a]=e;l.setVariable(n.stringValue,a.value)}),new TermlFunction("PUSH",["name","value"],[],(e,t,r)=>{Terml.checkType(e,[TermlList,TermlValueObject]);let[l,n]=e;l.value.push(n.value)}),new TermlFunction("INSERT_AT",["name","value","index"],[],(e,t,r)=>{Terml.checkType(e,[TermlList,TermlValueObject,TermlNumberLiteral]);let[l,n,a]=e;l.value.splice(a.value,0,n.value)}),new TermlFunction("POP",["name","?var"],[],(e,t,r)=>{if(!Terml.getTypeError(e,[TermlList])){let[l]=e;l.value.pop();return}Terml.checkType(e,[TermlList,TermlVariable]);let[n,a]=e;0!==n.value.length&&(a.value=n.value.pop())}),new TermlFunction("CONCAT",["list1","list2"],[],(e,t,r)=>{Terml.checkType(e,[TermlList,TermlList]);let[l,n]=e;l.value=l.value.concat(n.value)}),new TermlFunction("UNSHIFT",["name","value"],[],(e,t,r)=>{Terml.checkType(e,[TermlList,TermlValueObject]);let[l,n]=e;l.value.unshift(n.value)}),new TermlFunction("DELETE_AT",["name","index"],[],(e,t,r)=>{Terml.checkType(e,[TermlList,TermlValueObject]);let[l,n]=e;n.value>=l.value.length||l.value.splice(n.value,1)}),new TermlFunction("SHIFT",["name","?var"],[],(e,t,r)=>{if(!Terml.getTypeError(e,[TermlList])){let[l]=e;l.value.shift();return}Terml.checkType(e,[TermlList,TermlVariable]);let[n,a]=e;a.value=n.value.shift()}),new TermlFunction("GET_AT",["name","index","var"],[],(e,t,r)=>{Terml.checkType(e,[TermlList,TermlValueObject,TermlVariable]);let[l,n,a]=e;a.value=l.value[n.value]}),new TermlFunction("SET_AT",["name","index","value"],[],(e,t,r)=>{Terml.checkType(e,[TermlList,TermlValueObject,TermlValueObject]);let[l,n,a]=e;l.value[n.value]=a.value}),new TermlFunction("SET",["name","value"],[],(e,t,r)=>{Terml.checkType(e,[TermlVariable,TermlValueObject]);let[l,n]=e;l.value=n.value}),new TermlFunction("OUT",["value"],[],(e,t,r)=>{if(!Terml.getTypeError(e,[TermlValueObject])){let[l]=e,n=l.value;Array.isArray(n)&&(n=TermlStringLiteral.fromArray(n).stringValue),TermlSettings.OUT_FUNC((""+n).replace(/\\n/g,"\n"))}}),new TermlFunction("OUT_LST",["value"],[],(e,t,r)=>{Terml.checkType(e,[TermlValueObject]);let l=Terml.getTypeError(e,[TermlList]);if(l&&(l=Terml.getTypeError(e,[TermlStringLiteral])),l)throw l;let n=JSON.stringify(e[0].value);TermlSettings.OUT_FUNC(n)}),new TermlFunction("IN",["name"],[],(e,t,r)=>{Terml.checkType(e,[TermlList]);let[l]=e,n=TermlSettings.IN_FUNC();l.value=new TermlStringLiteral(n).value}),new TermlFunction("ADD",["var1","var2"],[],(e,t,r)=>{Terml.checkType(e,[TermlVariable,TermlValueObject]);let[l,n]=e;l.value+=n.value}),new TermlFunction("SUB",["var1","var2"],[],(e,t,r)=>{Terml.checkType(e,[TermlVariable,TermlValueObject]);let[l,n]=e;l.value-=n.value}),new TermlFunction("MUL",["var1","var2"],[],(e,t,r)=>{Terml.checkType(e,[TermlVariable,TermlValueObject]);let[l,n]=e;l.value*=n.value}),new TermlFunction("DIV",["var1","var2"],[],(e,t,r)=>{Terml.checkType(e,[TermlVariable,TermlValueObject]);let[l,n]=e;l.value/=n.value}),new TermlFunction("MOD",["var1","var2"],[],(e,t,r)=>{Terml.checkType(e,[TermlVariable,TermlValueObject]);let[l,n]=e;l.value%=n.value}),new TermlFunction("POW",["var1","var2"],[],(e,t,r)=>{Terml.checkType(e,[TermlVariable,TermlValueObject]);let[l,n]=e;l.value=Math.pow(l.value,n.value)}),new TermlFunction("ROUND",["var"],[],(e,t,r)=>{Terml.checkType(e,[TermlVariable]);let[l]=e;l.value=Math.round(l.value)}),new TermlFunction("SQRT",["var"],[],(e,t,r)=>{Terml.checkType(e,[TermlVariable]);let[l]=e;l.value=Math.sqrt(l.value)}),new TermlFunction("FLOOR",["var"],[],(e,t,r)=>{Terml.checkType(e,[TermlVariable]);let[l]=e;l.value=Math.floor(l.value)}),new TermlFunction("CEIL",["var"],[],(e,t,r)=>{Terml.checkType(e,[TermlVariable]);let[l]=e;l.value=Math.ceil(l.value)}),new TermlFunction("DEF",[],[],(e,t,r)=>{Terml.checkType(e[0],TermlStringLiteral);let l=e[0].value,n=e.slice(1);function a(e){if(e.length!==n.length)throw new TermlRuntimeNumArgumentsError;Terml.checkType(e,e.map(()=>TermlValueObject));for(let l=0;l<n.length;l++)t.container.setVariable(n[l].value,e[l].value);for(let a of t.substatements)r.executeStatement(a)}Terml.checkType(n,n.map(()=>TermlStringLiteral));let i=new TermlFunction(l,e,t.substatements,a);t.parent.container.setFunction(l,i)}),new TermlFunction("IS_EQ",["val1","val2","var"],[],e=>{Terml.checkType(e,[TermlValueObject,TermlValueObject,TermlVariable]);let[t,r,l]=e;l.value=t.value===r.value?1:0}),new TermlFunction("IS_LT",["val1","val2","var"],[],e=>{Terml.checkType(e,[TermlValueObject,TermlValueObject,TermlVariable]);let[t,r,l]=e;l.value=t.value<r.value?1:0}),new TermlFunction("IS_GT",["val1","val2","var"],[],e=>{Terml.checkType(e,[TermlValueObject,TermlValueObject,TermlVariable]);let[t,r,l]=e;l.value=t.value>r.value?1:0}),new TermlFunction("OR",["val1","val2","var"],[],e=>{Terml.checkType(e,[TermlValueObject,TermlValueObject,TermlVariable]);let[t,r,l]=e;l.value=t.value||r.value?1:0}),new TermlFunction("XOR",["val1","val2","var"],[],e=>{Terml.checkType(e,[TermlValueObject,TermlValueObject,TermlVariable]);let[t,r,l]=e,n=t.value?1:0,a=r.value?1:0;l.value=n^a?1:0}),new TermlFunction("NOT",["val1","var"],[],e=>{Terml.checkType(e,[TermlValueObject,TermlVariable]);let[t,r]=e;r.value=t.value?0:1}),new TermlFunction("AND",["val1","val2","var"],[],e=>{Terml.checkType(e,[TermlValueObject,TermlValueObject,TermlVariable]);let[t,r,l]=e,n=t.value?1:0,a=r.value?1:0;l.value=n&&a?1:0}),new TermlFunction("IF",["value"],[],(e,t,r)=>{Terml.checkType(e,[TermlValueObject]);let[l]=e;if(0!==l.value)for(let n of t.substatements)r.executeStatement(n)}),new TermlFunction("IF_NOT",["value"],[],(e,t,r)=>{Terml.checkType(e,[TermlValueObject]);let[l]=e;if(0===l.value)for(let n of t.substatements)r.executeStatement(n)}),new TermlFunction("WHILE",["value"],[],(e,t,r)=>{Terml.checkType(e,[TermlValueObject]);let[l]=e,n=0;for(;0!==l.value;){for(let a of t.substatements)r.executeStatement(a);if(++n>TermlSettings.maxRepeat)throw new TermlRuntimeMaxRepeatError("WHILE loop exceeded maximum number of iterations")}}),new TermlFunction("WHILE_NOT",["value"],[],(e,t,r)=>{Terml.checkType(e,[TermlValueObject]);let[l]=e,n=0;for(;0!==l.value;){for(let a of t.substatements)r.executeStatement(a);if(++n>TermlSettings.maxRepeat)throw new TermlRuntimeMaxRepeatError("WHILE_NOT loop exceeded maximum number of iterations")}}),new TermlFunction("REPEAT",["value"],[],(e,t,r)=>{let l=null;if(Terml.getTypeError(e,[TermlValueObject,TermlStringLiteral]))Terml.checkType(e,[TermlValueObject]);else{let n=t.container;n.setVariable(e[1].stringValue,void 0),l=n.getVariable(e[1].stringValue)}let a=e[0].value;if(a<0)throw new TermlRuntimeError("REPEAT value must be positive");if(a>TermlSettings.maxRepeat)throw new TermlRuntimeMaxRepeatError(`REPEAT value must be less than ${TermlSettings.maxRepeat}`);for(let i=0;i<a;i++)for(let m of(l&&(l.value=i),t.substatements))r.executeStatement(m)}),],[]);class TermlRuntime{constructor(e){this.preCode="",this.globalStatement=e,this.importModule(TermlStandardModule)}importModule(e){this.globalStatement.container.importModule(e)}execute(){this.executeStatement(this.globalStatement)}getVariable(e,t){t||(t=this.globalStatement);let r=t;for(;!r.container.variableExists(e);)if(!(r=r.parent))throw new TermlError(`Variable ${e} is not defined`);return r.container.getVariable(e)}getFunction(e,t){t||(t=this.globalStatement);let r=t;for(;!r.container.functionExists(e);)if(!(r=r.parent))throw new TermlError(`Function ${e} is not defined`);return r.container.getFunction(e)}executeStatement(e){let t=e.functionName.value,r=this.getFunction(t,e),l=e.args.map(t=>t.isLiteral?t:this.getVariable(t.value,e));r.execute(l,e,this)}}class Terml{static output="";static checkType(e,t){let r=Terml.getTypeError(e,t);if(r)throw r}static getTypeError(e,t){if(t instanceof Array){if(!(e instanceof Array))return new TermlRuntimeTypeError("Array");if(t.length!==e.length)return new TermlRuntimeNumArgumentsError;if(0!==t.length){for(let r of t)for(let l of e)if(l instanceof r)return;else return new TermlRuntimeTypeError(r.name);throw new TermlRuntimeTypeError(t.name)}}else{if(e instanceof t)return;return new TermlRuntimeTypeError(t.name)}}static get Settings(){return TermlSettings}static removeStaticWhitespace(e){let t=e.split("\n").filter(e=>e.length>0),r=e=>{for(let r of t)if(!r.startsWith(e))return!1;return!0},l=()=>{for(let e=0;e<t.length;e++)t[e]=t[e].slice(1);return 0===(t=t.filter(e=>e.length>0)).length};for(;r(" ")&&!l(););for(;r("	")&&!l(););return t.join("\n")}static furbishCode(e){let t=RegExp(`^[\\s\\t]*${TermlSettings.COMMENT_CHAR}.*$`);return e=e.split(TermlSettings.LINE_DELIMIETER).filter(e=>e.length>0).filter(e=>!t.test(e)).join(TermlSettings.LINE_DELIMIETER),e=Terml.removeStaticWhitespace(e).replaceAll(" ".repeat(TermlSettings.TAB_WIDTH),TermlSettings.INDENT_CHAR)}static run(e,{log:t=!1}={}){e=Terml.furbishCode(e),Terml.output="";let r=new TermlParser,l=r.parse(e),n=new TermlRuntime(l);return n.execute(),t&&Terml.logOutput(),Terml.output}static logOutput(){console.log(Terml.output)}static parseDocument(e){let t=e.querySelectorAll("terml");for(let r of t){let l=r.innerHTML,n=r.parentElement;r.remove();let a="";try{a=Terml.run(l)}catch(i){if(i instanceof TermlError)a=i.toString();else throw i}n.innerHTML+=a}}}window.addEventListener("load",()=>Terml.parseDocument(document));